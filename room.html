<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room - Speakers Server</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="room.css">
    <link rel="stylesheet" href="animations.css">
</head>
<body>
    <div class="room-container">
        <!-- Notes Modal (popup like settings) -->
        <div id="notesModal" class="notes-modal-room">
            <div class="notes-modal-content-room">
                <div class="notes-modal-header-room">
                    <h2>My Notes</h2>
                    <button class="notes-close-btn-room" id="closeNotesBtn" title="Close Notes">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="notes-modal-body-room">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="notes-action-btn-room" id="newFolderBtnRoom" title="New Folder">üìÅ New Folder</button>
                        <button class="notes-action-btn-room" id="newNoteBtnRoom" title="New Note">üìÑ New Note</button>
                    </div>
                    <div id="notesBreadcrumbRoom" class="notes-breadcrumb-room" style="margin-bottom: 1rem;"></div>
                    <div id="notesListRoom" style="flex: 1; overflow-y: auto; margin-bottom: 1rem;">
                        <!-- Notes tree will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Note Editor Modal (PDF-like popup) -->
        <div id="noteEditorModalRoom" class="note-editor-modal-room">
            <div class="note-editor-modal-toolbar-room">
                <div class="note-editor-modal-toolbar-left-room">
                    <input type="text" id="noteNameInputRoom" class="note-editor-modal-name-input-room" placeholder="Note name...">
                </div>
                <div class="note-editor-modal-toolbar-right-room">
                    <button class="notes-editor-btn-room" onclick="saveCurrentNoteRoom()">Save</button>
                    <button class="notes-editor-btn-icon-room delete" onclick="deleteCurrentNoteRoom()" title="Delete">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                    </button>
                    <button class="notes-editor-btn-icon-room close" onclick="closeNoteEditorRoom()" title="Close">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="note-editor-modal-page-room">
                <textarea id="noteContentTextareaRoom" class="note-editor-modal-textarea-room" placeholder="Start typing your notes..."></textarea>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <main class="room-main">
            <!-- Room Header -->
            <header class="room-header" style="flex-shrink: 0;">
                <div class="room-info">
                    <h1 id="roomTitle">Room Title</h1>
                    <span class="room-category" id="roomCategory"></span>
                    <span class="room-role" id="roomRole">Participant</span>
                </div>
                <div class="room-controls">
                    <button class="theme-toggle-btn-room" id="themeToggleBtnRoom" title="Toggle theme">
                        <span class="theme-icon-room">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>
                        </span>
                    </button>
                    
                    <!-- Participant controls -->
                    <button class="control-btn" id="raiseHandBtn" title="Raise Hand" style="display: none;">
                        <span>‚úã</span> Raise Hand
                    </button>
                    
                    <!-- Speaker controls (when invited to speak) -->
                    <button class="control-btn" id="micBtn" title="Mute/Unmute" style="display: none;">
                        <span>üé§</span>
                    </button>
                    
                    <!-- Notes button (only shown for logged-in users) -->
                    <button class="control-btn" id="notesBtn" title="View Notes" style="display: none;">
                        <span>üìù</span> Notes
                    </button>
                    
                    <!-- Participants button (everyone can see) -->
                    <button class="control-btn" id="participantsBtn" title="View Participants">
                        <span>üë•</span> <span id="participantCount">0</span>
                    </button>
                    
                    <button class="control-btn" id="endMeetingBtn" title="End Meeting" style="display: none;">
                        <span>üî¥</span> End Meeting
                    </button>
                    <button class="control-btn leave" id="leaveBtn" title="Leave Room">
                        <span>üö™</span> Leave
                    </button>
                </div>
            </header>

            <!-- Main Content Area -->
            <div class="main-content-area" id="mainContentArea">
                <!-- Active Speakers Section (Top) -->
                <div class="active-speakers-section">
                    <div class="speakers-container" id="speakersContainer">
                        <!-- Active speaker tiles will be added here -->
                    </div>
                </div>

                <!-- Audience Section (Bottom) -->
                <div class="audience-section">
                    <div class="audience-header">
                        <h3>Audience ‚Äî <span id="audienceCount">0</span></h3>
                        <input type="text" class="audience-search" placeholder="Search" id="audienceSearch">
                    </div>
                    <!-- Raised Hands Section -->
                    <div class="raised-hands-section" id="raisedHandsSection" style="display: none;">
                        <h4 class="raised-hands-title">Raised Hands ‚Äî <span id="raisedHandsCount">0</span></h4>
                        <div class="raised-hands-list" id="raisedHandsList">
                            <!-- Raised hands will appear here -->
                        </div>
                    </div>
                    <!-- Regular Audience List -->
                    <div class="audience-list" id="audienceList">
                        <!-- Audience member tiles will be added here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Participants Panel (visible to everyone) -->
        <div class="participants-panel" id="participantsPanel" style="display: none;">
            <div class="panel-header">
                <h3>Participants</h3>
                <button class="close-panel" id="closePanelBtn">√ó</button>
            </div>
            <div class="panel-tabs">
                <button class="panel-tab active" data-tab="all">All (<span id="allCount">0</span>)</button>
                <button class="panel-tab" data-tab="speakers">Speakers (<span id="speakersCount">0</span>)</button>
                <button class="panel-tab" data-tab="raised">Raised Hands (<span id="raisedCount">0</span>)</button>
            </div>
            <div class="panel-content" id="panelContent">
                <!-- Participants will be listed here -->
            </div>
        </div>

        <!-- Right Sidebar - Chat -->
        <aside class="chat-sidebar">
            <div class="sidebar-header">
                <h3>Chat</h3>
                <span class="chat-badge">Everyone can chat</span>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Chat messages will appear here -->
            </div>
            <div class="chat-input-container" id="chatInputContainer">
                <input 
                    type="text" 
                    id="chatInput" 
                    placeholder="Type a message..."
                    autocomplete="off"
                >
                <button id="sendBtn" class="send-btn">Send</button>
            </div>
            <div class="chat-login-prompt" id="chatLoginPrompt" style="display: none;">
                <p style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                    <a href="auth.html" style="color: var(--primary-color); text-decoration: underline;">Login</a> to join the chat
                </p>
            </div>
        </aside>
    </div>

    <!-- Meeting Ended Modal -->
    <div id="meetingEndedModal" class="meeting-ended-modal" style="display: none;">
        <div class="meeting-ended-content">
            <div class="meeting-ended-icon">üî¥</div>
            <h2>Meeting Ended</h2>
            <p>The host has ended the meeting. You will be redirected to the home page.</p>
            <button class="btn-primary" id="goHomeBtn">Go to Home</button>
        </div>
    </div>

    <!-- Participant Menu Modal -->
    <div id="participantMenuModal" class="participant-menu-modal">
        <div class="participant-menu-content">
            <div class="participant-menu-header">
                <h3 id="participantMenuName">Participant</h3>
                <button class="participant-menu-close" id="participantMenuClose">&times;</button>
            </div>
            <div class="participant-menu-options" id="participantMenuOptions">
                <!-- Options will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- LiveKit Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.min.js"></script>
    
    <!-- Inline Configuration (Safe for production - Supabase anon key is protected by RLS) -->
    <script>
        // Configuration - automatically works in both local and production environments
        const SUPABASE_URL = 'https://rtxpelmkxxownbafiwmz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0eHBlbG1reHhvd25iYWZpd216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NTc5OTIsImV4cCI6MjA4MTQzMzk5Mn0.QKnVeBOaPYbkcSpm5zU2CtGa0uJ06z55Oas8Q-ShxZY';
        const LIVEKIT_URL = 'wss://speakersserver-0je4i45z.livekit.cloud';
        
        // Detect environment and set token server URL
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const TOKEN_SERVER_URL = isLocal ? 'http://localhost:3001' : window.location.origin + '/api/token';
        
        // Initialize Supabase client - check if already exists to avoid redeclaration
        function initializeSupabase() {
            // Check if supabase client already exists (from another page)
            if (typeof supabase !== 'undefined' && supabase !== null) {
                console.log('Reusing existing Supabase client');
                return supabase;
            }
            
            // Check if Supabase library is loaded
            if (typeof window.supabase === 'undefined' || !window.supabase.createClient) {
                console.warn('Supabase library not loaded yet, retrying...');
                setTimeout(initializeSupabase, 100);
                return null;
            }
            
            // Create the client
            var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('‚úÖ Supabase client initialized');
            return supabase;
        }
        
        // Initialize immediately (will retry if library not ready)
        var supabase = initializeSupabase();
        
        console.log('‚úÖ Configuration loaded', { environment: isLocal ? 'local' : 'production' });
    </script>
    
    <!-- Room Script -->
    <script src="room.js"></script>
</body>
</html>

